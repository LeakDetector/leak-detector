{% extends "base.html" %}
{% block content %}
<div class="row">
	<div class="small-12 columns">
		<h1>Leak Detector</h1>
		<p>To get started, record a network session and obtain network usage data.</p>
	    <div class="row">
	    	<div class="small-12 columns">
				<label>Save this trace as...</label>
			 	<input type="text" name="trace-name" value="{{defaultnm}}" id="trace-name">
	    	</div>
		</div>

		<div class="row">
			<div class="large-12 columns">
				<label>Network Interface</label>
				{% for iface in interfaces %}
				<input type="radio" name="interface" value="{{iface}}" id="iface-{{iface}}"><label for="iface-{{iface}}" class="iface">{{iface}}</label>
				{% else %}
				<p>Error: no available network interfaces to record from.</p>
				{% endfor %}
			</div>
		</div>
		<div class="row">
			<div class="small-12 columns">
				<p><button id="start-recording" class="button">Start Recording</button></p>
			</div>	
		</div>	
	</div>
</div>	

<div id="error-modal" class="reveal-modal" data-reveal>
	<h2>Error</h2>
	<p></p>
	<a class="close-reveal-modal">&#215;</a>
</div>	

<div id="recording-modal" class="reveal-modal" data-reveal data-options="close_on_background_click:false;close_on_esc:false;">
	<h2>Recording network traffic</h2>
	<p>Leak Detector says:</p>
	<div id="stdout"></div>
	<div class="when-active">
		<p><img src="{{url_for('static', filename='img/ajax-loader.gif')}}" title="Recording..." /></p>
		<p id="message"></p>
		<p><a href="#" id="stop-recording" class="button">Finish Recording</a></p>
	</div>	
</div>	

{% endblock %}
{% block extrajs %}
<script type="text/javascript">
	{% if config.session %}
	recording = true;
	{% else %}
	recording = false;
	{% endif %}
	
	var REC_START = "start";
	var REC_STOP = "stop";
	var ERR = "ERR";
	
	$("#start-recording").click(function(){
		iface = $("input[name='interface']:checked").val();
		fn = $("input[name='trace-name']").val();
		if ( !iface ) {
			ui_error("Please choose a network interface to record.");
		} else if ( !fn ) {
			ui_error("Please choose a name for your network trace.");
		} else {
			var startArgs = {
				'action': REC_START,
				'interface': iface,
				'fn': fn + ".json"
			};
			$.post("/record", startArgs, function(data){
				if ( data == REC_START ) {
					ui_start();
				} else if ( data.search(ERR) != -1 ) {
					var error = data.split(ERR + " ")[1];
					ui_error(error);
				}
			});			
		}
	});
	
	$("#stop-recording").click(function() {
		var stopArgs = {'action': REC_STOP};
		$.post("/record", stopArgs, function(data){
			if ( data.action == REC_STOP ) {
				ui_stop();
			} else if ( data.search(ERR) != -1 ) {
				var error = data.split(ERR + " ")[1];
				ui_error(error);
			}
		});
	});
	
	function updateData() {
		$.getJSON('/proc-status', function(data) {
			$.each(data.stdout, function(i, l){
				$("#stdout").append("<span>" + l + "</span><br/>");
			});
		});
	}
	
	function ui_start() {
		recording = true;
		$("#recording-modal").foundation('reveal', 'open');
		$("#recording-modal p#message").html("Currently recording network traffic from <span>" + iface + "</span>.");
		setTimeout(updateData, 5000);
	}
	
	function ui_stop() {
		recording = false;		
		$(".when-active").slideUp(400);
		$("#recording-modal h2").html("Finished recording")
		$("#recording-modal").append("<a class='close-reveal-modal button'>&#215; Close</a>");
		setTimeout(updateData, 3000);
	}
	
	function ui_error(message) {
		$("#error-modal p").html(message);
		$("#error-modal").foundation('reveal', 'open');
	}
	
	$(document).ready(function() {
		if ( recording ) {
			iface = "an existing session";
			ui_start();
		}
	})
</script>
{% endblock %}